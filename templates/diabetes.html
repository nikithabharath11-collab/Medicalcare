{% extends "base.html" %}
{% block title %}Diabetes Prediction{% endblock %}

{% block content %}
<div class="prediction-page">
    <div class="page-header">
        <h1>Diabetes Prediction</h1>
        <p>Assess diabetes risk using health indicators with Random Forest Classifier</p>
    </div>

    <div class="form-card">
        <form id="diabetesForm">
            <div class="form-grid">
                <div class="form-group">
                    <label>Pregnancies</label>
                    <input type="number" name="pregnancies" min="0" max="20" required placeholder="e.g., 2">
                </div>
                <div class="form-group">
                    <label>Glucose Level (mg/dL)</label>
                    <input type="number" name="glucose" min="0" max="300" required placeholder="e.g., 120">
                </div>
                <div class="form-group">
                    <label>Blood Pressure (mm Hg)</label>
                    <input type="number" name="bloodPressure" min="0" max="200" required placeholder="e.g., 70">
                </div>
                <div class="form-group">
                    <label>Skin Thickness (mm)</label>
                    <input type="number" name="skinThickness" min="0" max="100" required placeholder="e.g., 20">
                </div>
                <div class="form-group">
                    <label>Insulin Level (mu U/ml)</label>
                    <input type="number" name="insulin" min="0" max="900" required placeholder="e.g., 80">
                </div>
                <div class="form-group">
                    <label>BMI (Body Mass Index)</label>
                    <input type="number" name="bmi" min="10" max="70" step="0.1" required placeholder="e.g., 25.5">
                </div>
                <div class="form-group">
                    <label>Diabetes Pedigree Function</label>
                    <input type="number" name="dpf" min="0" max="3" step="0.001" required placeholder="e.g., 0.5">
                </div>
                <div class="form-group">
                    <label>Age (years)</label>
                    <input type="number" name="age" min="1" max="120" required placeholder="e.g., 45">
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">Predict Diabetes Risk</button>
            </div>
        </form>
    </div>

    <div class="spinner" id="spinner"></div>
    <div class="result-card" id="resultCard">
        <div class="result-header">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-title">
                <h3 id="resultTitle"></h3>
                <p id="resultSubtitle"></p>
            </div>
        </div>
        <div class="result-details" id="resultDetails"></div>
        <div style="text-align: center; margin-top: 1.5rem;">
            <button class="btn btn-gold-outline btn-sm" onclick="downloadReport()">Download PDF Report</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('diabetesForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const spinner = document.getElementById('spinner');
    const resultCard = document.getElementById('resultCard');
    resultCard.classList.remove('show');
    spinner.classList.add('show');

    const data = {};
    new FormData(e.target).forEach((val, key) => data[key] = val);

    try {
        const res = await fetch('/api/predict/diabetes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const json = await res.json();
        spinner.classList.remove('show');

        if (json.status === 'success') {
            const r = json.result;
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const subtitle = document.getElementById('resultSubtitle');
            const details = document.getElementById('resultDetails');

            if (r.prediction === 1) {
                icon.className = 'result-icon danger';
                icon.innerHTML = '&#9888;';
                title.textContent = 'Diabetic - Positive';
                subtitle.textContent = 'High risk of diabetes detected. Please consult an endocrinologist.';
            } else {
                icon.className = 'result-icon success';
                icon.innerHTML = '&#10003;';
                title.textContent = 'Non-Diabetic - Negative';
                subtitle.textContent = 'Low risk of diabetes. Maintain healthy diet and exercise!';
            }

            details.innerHTML = `
                <div class="result-item">
                    <div class="value">${r.confidence}%</div>
                    <div class="label">Model Confidence</div>
                </div>
                <div class="result-item">
                    <div class="value" style="color: #198754">${r.probabilities.non_diabetic}%</div>
                    <div class="label">Non-Diabetic Probability</div>
                    <div class="progress-bar-container"><div class="progress-bar green" style="width:${r.probabilities.non_diabetic}%"></div></div>
                </div>
                <div class="result-item">
                    <div class="value" style="color: #dc3545">${r.probabilities.diabetic}%</div>
                    <div class="label">Diabetic Probability</div>
                    <div class="progress-bar-container"><div class="progress-bar red" style="width:${r.probabilities.diabetic}%"></div></div>
                </div>
            `;
            resultCard.classList.add('show');
            window._lastResult = r;
        } else {
            alert('Error: ' + json.message);
        }
    } catch(err) {
        spinner.classList.remove('show');
        alert('Error connecting to server.');
    }
});

async function downloadReport() {
    if (!window._lastResult) return;
    const r = window._lastResult;
    try {
        const res = await fetch('/api/generate-report', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                model: 'Diabetes Prediction',
                result: r.risk,
                confidence: r.confidence,
                details: 'Non-Diabetic: ' + r.probabilities.non_diabetic + '%\nDiabetic: ' + r.probabilities.diabetic + '%'
            })
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'MedicalCare_Diabetes_Report.pdf'; a.click();
        URL.revokeObjectURL(url);
    } catch(err) { alert('Error generating report.'); }
}
</script>
{% endblock %}
